name: Build Linux Kernel for AARCH64
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Maximum build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          swap-size-mb: 256
          remove-dotnet: true
          remove-android: true
          remove-docker-images: true
          remove-codeql: true
          remove-haskell: true

      - name: Checkout
        uses: actions/checkout@v3

      - name: Add dependencies
        run: |
          sudo apt remove $(dpkg --get-selections docker.io docker-compose docker-compose-v2 docker-doc podman-docker containerd runc | cut -f1)
          sudo apt install -y ca-certificates curl
          sudo install -m 0755 -d /etc/apt/keyrings
          sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          sudo chmod a+r /etc/apt/keyrings/docker.asc

          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker build environment
        run: |
          sudo docker buildx build --platform linux/arm64 -t builder .

      - name: Download kernel
        run: |
          git clone -b v6.18.9 --depth 1 'https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' --single-branch

      - name: Compile kernel
        run: |
          set -ex
          shopt -s expand_aliases
          alias builder='sudo docker run --platform linux/arm64 -v ${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE} -w $(pwd) builder:latest'
          mkdir -p linux-headers
          cp .config_aarch64 linux-headers/.config

          pushd linux
          builder make mrproper
          builder make O=../linux-headers olddefconfig
          builder make O=../linux-headers modules_prepare
          popd

          rm linux-headers/source
          rm linux-headers/.config
          mkdir -p release

          pushd linux
          builder make mrproper
          cp ../.config_aarch64 .config
          builder scripts/config --disable DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT
          builder scripts/config --disable DEBUG_INFO
          builder make olddefconfig
          builder make -j$(nproc)
          cp Module.symvers ../linux-headers/

          mkdir -p linux-kernel
          builder make INSTALL_MOD_PATH=linux-kernel modules_install
          mkdir -p linux-kernel/boot
          builder make install INSTALL_PATH=linux-kernel/boot
          builder tar zcvf linux-image-arm64-$(make kernelrelease).tar.gz -C linux-kernel/ .
          builder bash -c "make kernelrelease > version"
          echo "RELEASE_VERSION=$(version)" >> $GITHUB_ENV

          echo "RELEASE_NAME=$(ls linux-image-arm64*.tar.gz)" >> $GITHUB_ENV
          mv $RELEASE_NAME ../release

          mkdir -p debs
          builder bash -c "make -j$(nproc) bindeb-pkg && mv ../*.deb debs"
          mv debs/*.deb ../release
          popd

          mkdir -p ./usr/src/linux-headers-$RELEASE_VERSION
          mv linux-headers/* ./usr/src/linux-headers-$RELEASE_VERSION
          tar -zcvf linux-headers-arm64-$RELEASE_VERSION.tar.gz ./usr
          mv linux-headers-arm64-$RELEASE_VERSION.tar.gz release

      - name: "Generate artifact"
        uses: actions/upload-artifact@v4
        with:
          name: linux-kernel
          path: ./release/*
